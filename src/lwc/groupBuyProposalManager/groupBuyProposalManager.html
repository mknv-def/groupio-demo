<template>
    <div class="proposal-manager-container">
        
        <!-- Notification -->
        <template lwc:if={hasNotification}>
            <div class={notificationClass}>
                <lightning-icon icon-name={notificationIcon} size="x-small"></lightning-icon>
                <span class="notification-message">{notification.message}</span>
                <button class="notification-close" onclick={handleCloseNotification}>
                    <lightning-icon icon-name="utility:close" size="xx-small"></lightning-icon>
                </button>
            </div>
        </template>

        <!-- Main Tabs -->
        <lightning-tabset variant="scoped" active-tab-value={mainActiveTab}>
            
            <!-- CREATE PROPOSAL TAB -->
            <lightning-tab label="Create Proposal" value="create" icon-name="utility:add" onactive={handleMainTabActive}>
                <div class="slds-p-around_medium">
                    <!-- Account Banner -->
                    <template lwc:if={hasAccountId}>
                        <div class="account-banner">
                            <lightning-icon icon-name="standard:account" size="small"></lightning-icon>
                            <span><strong>Creating for:</strong> {accountDisplayName}</span>
                        </div>
                    </template>

                    <!-- Proposal Form Component -->
                    <c-group-buy-proposal-form
                        account-id={accountId}
                        oncreated={handleProposalCreated}
                        onerror={handleError}>
                    </c-group-buy-proposal-form>
                </div>
            </lightning-tab>

            <!-- MY PROPOSALS TAB -->
            <lightning-tab label="My Proposals" value="manage" icon-name="utility:list" onactive={handleMainTabActive}>
                <div class="slds-p-around_medium">
                    <!-- Proposals List Component -->
                    <c-group-buy-proposal-list
                        account-id={accountId}
                        refresh-key={refreshKey}
                        onview={handleViewProposal}
                        onedit={handleEditProposal}
                        ondelete={handleDeleteProposal}
                        onmanagediscounts={handleManageDiscounts}
                        onerror={handleError}
                        onsuccess={handleSuccess}>
                    </c-group-buy-proposal-list>
                </div>
            </lightning-tab>
        </lightning-tabset>

        <!-- VIEW PROPOSAL MODAL -->
        <template lwc:if={showViewModal}>
            <c-group-buy-proposal-detail
                proposal={viewProposal}
                active-tab={viewProposalActiveTab}
                onclose={handleCloseViewModal}
                onedit={handleEditFromView}
                onsubmitforapproval={handleSubmitForApprovalFromView}
                onerror={handleError}>
            </c-group-buy-proposal-detail>
        </template>

        <!-- EDIT PROPOSAL MODAL -->
        <template lwc:if={showEditModal}>
            <c-group-buy-proposal-edit-modal
                proposal-id={editProposalId}
                onclose={handleCloseEditModal}
                onsave={handleProposalUpdated}
                onerror={handleError}>
            </c-group-buy-proposal-edit-modal>
        </template>

        <!-- DELETE CONFIRMATION MODAL -->
        <template lwc:if={showDeleteModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header slds-modal__header_empty">
                        <lightning-button-icon
                            icon-name="utility:close"
                            variant="bare-inverse"
                            class="slds-modal__close"
                            onclick={handleCloseDeleteModal}>
                        </lightning-button-icon>
                    </header>
                    <div class="slds-modal__content slds-p-around_large slds-text-align_center">
                        <div class="delete-icon-container">
                            <lightning-icon icon-name="utility:warning" variant="warning" size="large"></lightning-icon>
                        </div>
                        <h2 class="slds-text-heading_medium slds-m-top_medium slds-m-bottom_small">Delete Proposal?</h2>
                        <p class="slds-text-body_regular slds-text-color_weak">
                            Are you sure you want to delete "<strong>{deleteProposal.Name}</strong>"?<br/>
                            This action cannot be undone.
                        </p>
                    </div>
                    <footer class="slds-modal__footer slds-modal__footer_directional">
                        <lightning-button label="Cancel" onclick={handleCloseDeleteModal}></lightning-button>
                        <lightning-button label="Delete" variant="destructive" onclick={handleProposalDeleted}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </div>
</template>
